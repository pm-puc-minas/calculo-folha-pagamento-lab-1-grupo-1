package com.payroll.controller;

import com.payroll.entity.Employee;
import com.payroll.entity.Payroll;
import com.payroll.service.EmployeeService;
import com.payroll.service.PayrollService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.*;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.math.BigDecimal;
import java.util.*;
import java.util.stream.Collectors;

@RestController
@RequestMapping("/api/dashboard")
public class DashboardController implements IDashboardController {

    private static final Logger logger = LoggerFactory.getLogger(DashboardController.class);

    @Autowired
    private EmployeeService employeeService;

    @Autowired
    private PayrollService payrollService;

    // DTOs internos para enviar apenas os dados necessários
    public record EmployeeDTO(Long id, String name, String position, BigDecimal grossSalary) {}
    public record PayrollDTO(Long id, String employeeId, BigDecimal netSalary, Date createdAt) {}

    @GetMapping
    @Override
    public ResponseEntity<?> getDashboardData(@AuthenticationPrincipal UserDetails currentUser) {
        try {
            // Carregar todos os funcionários e folhas de pagamento
            List<Employee> allEmployees = employeeService.getAllEmployees();
            List<Payroll> allPayrolls = payrollService.getAllPayrolls();

            // Estatísticas
            int totalEmployees = allEmployees.size();
            int totalPayrolls = allPayrolls.size();

            // Limitar resultados recentes a 5
            List<EmployeeDTO> recentEmployees = allEmployees.stream()
                    .sorted(Comparator.comparing(Employee::getAdmissionDate).reversed())
                    .limit(5)
                    .map(emp -> new EmployeeDTO(emp.getId(), emp.getName(), emp.getPosition(), emp.getGrossSalary()))
                    .collect(Collectors.toList());

            List<PayrollDTO> recentPayrolls = allPayrolls.stream()
                    .sorted(Comparator.comparing(Payroll::getCreatedAt).reversed())
                    .limit(5)
                    .map(p -> new PayrollDTO(p.getId(), p.getEmployeeId(), p.getNetSalary(), p.getCreatedAt()))
                    .collect(Collectors.toList());

            // Montar resposta
            Map<String, Object> dashboardData = new HashMap<>();
            dashboardData.put("totalEmployees", totalEmployees);
            dashboardData.put("totalPayrolls", totalPayrolls);
            dashboardData.put("recentEmployees", recentEmployees);
            dashboardData.put("recentPayrolls", recentPayrolls);
            dashboardData.put("currentUser", currentUser != null ? currentUser.getUsername() : null);

            return ResponseEntity.ok(dashboardData);

        } catch (Exception e) {
            logger.error("Erro ao carregar dados do dashboard", e);
            return ResponseEntity.internalServerError()
                    .body(Map.of("error", "Erro ao carregar dados do dashboard"));
        }
    }
}
